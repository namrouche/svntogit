<project name="esup-ecm-config" default="deploy">

  <property file="build.properties"/>
  <property name="nuxeo-ep.file" value="nuxeo-ep-5.1.4.GA-1.zip"/>
  <property name="nuxeo-ep-unziped.file" value="${nuxeo.dir.parent}/nuxeo-ep-5.1.4.GA/server/default/deploy/nuxeo.ear/nuxeo.war/WEB-INF/web.xml"/>
  <property name="nuxeo-nxshell.file" value="nuxeo-shell-5.1.4.zip"/>
  <property name="nuxeo-nxshell-unziped.file" value="${nuxeo.dir.parent}/nuxeo-shell/run.sh"/>
  <property name="nuxeo.dir" value="${nuxeo.dir.parent}/nuxeo-ep-5.1.4.GA"/>
  <property name="jboss.home" value="${nuxeo.dir}"/>
  <property name="esup-ecm.file" value="esup-ecm-0.2" />

  <taskdef 
      resource="net/sf/antcontrib/antlib.xml" 
      classpath="ant-utils/ant-contrib-1.0.jar"/>

  <target name="prepare">
    <mkdir  dir="build"/>
    <mkdir  dir="build"/>
    <mkdir  dir="build/jboss"/>
    <mkdir  dir="build/esup-ecm-config-plugin"/>
    <mkdir  dir="packages"/>
  	<mkdir dir="${nuxeo.dir.parent}/nuxeo-shell"/>
    <available file="packages/${nuxeo-ep.file}" property="nuxeo-ep.file.present" />
    <available file="packages/${nuxeo-nxshell.file}" property="nuxeo-nxshell.file.present" />
    <available file="${nuxeo-ep-unziped.file}" property="nuxeo-ep.unziped.file.present" />
    <available file="${nuxeo-nxshell-unziped.file}" property="nuxeo-nxshell.unziped" />
    <antcall target="get.nuxeo-ep.file" />
    <antcall target="get.nuxeo-nxshell.file" />
  </target>
  	
	  <target name="get.nuxeo-ep.file" unless="nuxeo-ep.file.present">
	    <echo message="Téléchargement de ${nuxeo-ep.file} dans le répertoire packages."/>
	    <echo message="Ce téléchargement peut prendre plusieurs minutes..."/>
	    <get src="http://www.nuxeo.org/static/NuxeoEP/${nuxeo-ep.file}" dest="packages/${nuxeo-ep.file}" verbose="false"/>
	  </target>

	  <target name="get.nuxeo-nxshell.file" unless="nuxeo-nxshell.file.present">
	    <echo message="Téléchargement de ${nuxeo-nxshell.file} dans le répertoire packages."/>
	    <echo message="Ce téléchargement peut prendre plusieurs minutes..."/>
	    <get src=" http://download.nuxeo.org/nuxeo-shell/${nuxeo-nxshell.file}" dest="packages/${nuxeo-nxshell.file}" verbose="false"/>
	  </target>

  <target name="deploy.nuxeo" depends="prepare">
  	<antcall target="deploy.nuxeo.ep" />
  	<antcall target="deploy.nuxeo.nxshell" />
  </target>
	
	<target name="deploy.nuxeo.ep" unless="nuxeo-ep.unziped.file.present">
	    <unzip src="packages/${nuxeo-ep.file}" dest="${nuxeo.dir.parent}" />
	</target>

	<target name="deploy.nuxeo.nxshell" unless="nuxeo-nxshell-unziped.file">
	    <unzip src="packages/${nuxeo-nxshell.file}" dest="${nuxeo.dir.parent}/nuxeo-shell" />
	</target>

	<target name="clean">
    <delete  dir="build"/>
    <delete  dir="packages"/>
    <delete  dir="esup-ecm-config-plugin/target"/>
  </target>


  <target name="copy.src.build" depends="prepare">
    <copy todir="build" overwrite="yes">
      <fileset dir="db-configs"/>
    </copy>
    <copy todir="build/jboss" overwrite="yes">
      <fileset dir="jboss"/>
    </copy>
     <copy todir="build/esup-ecm-config-plugin" overwrite="yes">
     <fileset dir="esup-ecm-config-plugin"/>
    </copy>
  </target>

  <target name="replace.token.config" depends="copy.src.build">


    <echo message="Mise a jour des fichiers lies aux base de donnees usuelles (autres que JCR)" />

    <replace dir="build" includes="config/*.xml,datasources/*.xml">
      <replacefilter 
	  token="@jdbcUser@" value="${db.user}" />
      <replacefilter 
	  token="@jdbcPassword@" value="${db.password}" />
      <replacefilter 
	  token="@jdbcDriver@" value="${db.driver}" />
      <replacefilter 
	  token="@jdbcUrl@" value="${db.url}" />
      <replacefilter 
	  token="@jdbcJcrUrl@" value="${db.jcr.url}" />
    </replace>

    <echo message="Mise a jour des fichiers lies au plugin de configuration" />

    <!-- tools -->
    <replace file="build/jboss/jbossctl">
      <replacefilter token="@jbossUser@" value="${jboss.user}" />
        <replacefilter token="@jbossHome@" value="${jboss.home}" />
        <replacefilter token="@jdkHome@" value="${jdk.home}" />
    </replace>
    <replace file="build/jboss/server.xml">
      <replacefilter token="@tomcatPortHttp@" value="${tomcat.port.http}" />
      <replacefilter token="@tomcatPortJk@" value="${tomcat.port.jk}" />
    </replace>
  	
  	
  	<!-- build.properties -->
    <replace file="build/esup-ecm-config-plugin/build.properties" 
	     token="@nuxeo-dir@" value="${nuxeo.dir}" />

    <!-- CAS -->
    <replace file="build/esup-ecm-config-plugin/src/main/resources/OSGI-INF/login-contrib.xml" 
	     token="@sso-cas-url@" value="${cas.url}" />
    <replace file="build/esup-ecm-config-plugin/src/main/resources/OSGI-INF/login-contrib.xml" 
	     token="@nuxeo-url@" value="${nuxeo.url}" />

    <!-- LDAP -->
    <replace file="build/esup-ecm-config-plugin/src/main/resources/config/default-ldap-users-directory-bundle.xml">
      <replacefilter token="@ldapUrl@" value="${ldap.url}" />
      <replacefilter token="@ldapSearchBaseDn@" value="${ldap.user.searchBaseDn}" />
      <replacefilter token="@ldapFirstName@" value="${ldap.user.firstName}" />
      <replacefilter token="@ldapLastName@" value="${ldap.user.lastName}" />
      <replacefilter token="@ldapCompagny@" value="${ldap.user.company}" />
      <replacefilter token="@ldapEmail@" value="${ldap.user.email}" />
    </replace>
    <replace file="build/esup-ecm-config-plugin/src/main/resources/config/default-ldap-groups-directory-bundle.xml">
      <replacefilter token="@ldapSearchBaseDn@" value="${ldap.group.searchBaseDn}" />
    </replace>

    <!-- Administrator ID -->
    <replace file="build/esup-ecm-config-plugin/src/main/resources/config/default-virtual-groups-bundle.xml">
      <replacefilter token="@defaultAdministratorId@" value="${ldap.user.defaultAdministratorId}" />
    </replace>

  </target>

  
  <target name="deploy.plugin" depends="replace.token.config">

    <!-- impossible de configurer cela dynamiquement via un plugin -->
    <copy todir="${nuxeo.dir}/server/default/deploy/nuxeo.ear/datasources" overwrite="yes">
      <fileset dir="build/datasources"/>
    </copy>

    <!-- requis pour jenia - impossible de configurer cela dynamiquement via un plugin -->
    <copy file="build/config/sql.properties"  tofile="${nuxeo.dir}/server/default/deploy/nuxeo.ear/config/sql.properties" overwrite="yes"/>
    <!-- JCR - impossible de configurer cela dynamiquement via un plugin (depuis la 5.1.4) -->
    <copy file="build/config/default-repository-config.xml"  tofile="${nuxeo.dir}/server/default/deploy/nuxeo.ear/config/default-repository-config.xml" overwrite="yes"/>

  	<!-- configuration jboss -->
    <copy file="build/jboss/jbossctl" todir="${nuxeo.dir}/bin" overwrite="yes"/>
    <copy file="build/jboss/server.xml" tofile="${nuxeo.dir}/server/default/deploy/jbossweb-tomcat55.sar/server.xml" overwrite="yes"/>

    <!-- librairies supplementaires [driver postgres] -->
    <copy todir="${nuxeo.dir}/server/default/lib"  overwrite="yes">
      <fileset dir="lib"/>
    </copy>

    <!-- plugins addons nuxeo supplementaires --> 
    <copy todir="${nuxeo.dir}/server/default/deploy/nuxeo.ear/plugins"  overwrite="yes">
      <fileset dir="nuxeo-addons"/>
    </copy>
  	
    <!-- deploiement du plugin de configuration -->
    <subant target="deploy" buildpath="build/esup-ecm-config-plugin"/>

  </target>
	
  <target name="web" description="Copy web files to a live JBoss">
    <copy todir="${jboss.home}/server/default/deploy/nuxeo.ear/nuxeo.war" overwrite="true">
      <fileset dir="${basedir}/esup-ecm-config-plugin/src/main/resources/nuxeo.war/" />
    </copy>
  </target>

  <target name="deploy" depends="deploy.nuxeo,deploy.plugin" />

    <target name="buildzip" depends="prepare">
	    <echo message="Construction de ${esup-ecm.file}.zip ...."/>
	    <delete file="packages/${esup-ecm.file}.zip"/>
	    <zip destfile="packages/${esup-ecm.file}.zip" >
	       <zipfileset dir="" prefix="${esup-ecm.file}">
	       	<include name="**/*"/>
            <exclude name="**/.*"/>
            <exclude name="**/build/**"/>
            <exclude name="**/bin/**"/>
            <exclude name="packages/${esup-ecm.file}.zip"/>
	       	<exclude name="build.properties"/>
	       </zipfileset>
	    </zip>
    </target>

</project>


