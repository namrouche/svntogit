<project name="esup-ecm-config" default="deploy">


  <taskdef 
      resource="net/sf/antcontrib/antlib.xml" 
      classpath="ant-utils/ant-contrib-1.0.jar"/>


  <target name="prepare">
    <mkdir  dir="build"/>
    <mkdir  dir="build/datasources"/>
    <mkdir  dir="build/jboss"/>
    <mkdir  dir="build/esup-ecm-config-plugin"/>
  </target>

  <target name="clean">
    <delete  dir="build"/>
    <delete  dir="esup-ecm-config-plugin/target"/>
  </target>


  <target name="copy.src.build" depends="prepare">
    <copy todir="build/datasources" overwrite="yes">
      <fileset dir="datasources"/>
    </copy>
    <copy todir="build/jboss" overwrite="yes">
      <fileset dir="jboss"/>
    </copy>
     <copy todir="build/esup-ecm-config-plugin" overwrite="yes">
     <fileset dir="esup-ecm-config-plugin"/>
    </copy>
  </target>

  <target name="replace.token.config" depends="copy.src.build">


    <echo message="Mise a jour des fichiers lies aux base de donnees usuelles (autres que JCR)" />

    <replace dir="build/datasources" includes="*.xml">
      <replacefilter 
	  token="@jdbcUser@" value="${db.user}" />
      <replacefilter 
	  token="@jdbcPassword@" value="${db.password}" />
      <replacefilter 
	  token="@jdbcDriver@" value="${db.driver}" />
      <replacefilter 
	  token="@jdbcUrl@" value="${db.url}" />
    </replace>

    <echo message="Mise a jour des fichiers lies au plugin de configuration" />

    <!-- tools -->
    <replace file="build/jboss/jbossctl">
      <replacefilter token="@jbossUser@" value="${jboss.user}" />
      <replacefilter token="@jbossHome@" value="${jboss.home}" />
    </replace>
    <replace file="build/jboss/server.xml">
      <replacefilter token="@tomcatPortHttp@" value="${tomcat.port.http}" />
      <replacefilter token="@tomcatPortJk@" value="${tomcat.port.jk}" />
    </replace>
  	
  	
  	<!-- build.properties -->
    <replace file="build/esup-ecm-config-plugin/build.properties" 
	     token="@nuxeo-dir@" value="${nuxeo.dir}" />

    <!-- CAS -->
    <replace file="build/esup-ecm-config-plugin/src/main/resources/OSGI-INF/login-cas2-contrib.xml" 
	     token="@sso-cas-url@" value="${cas.url}" />
    <replace file="build/esup-ecm-config-plugin/src/main/resources/OSGI-INF/login-cas2-contrib.xml" 
	     token="@nuxeo-url@" value="${nuxeo.url}" />

    <!-- JCR DB -->
    <replace file="build/esup-ecm-config-plugin/src/main/resources/config/default-repository-config.xml"
	     token="@jdbcUser@" value="${db.user}" />
    <replace file="build/esup-ecm-config-plugin/src/main/resources/config/default-repository-config.xml"
	     token="@jdbcPassword@" value="${db.password}" />
    <replace file="build/esup-ecm-config-plugin/src/main/resources/config/default-repository-config.xml"
	     token="@jdbcDriver@" value="${db.driver}" />
    <replace file="build/esup-ecm-config-plugin/src/main/resources/config/default-repository-config.xml"
	     token="@jdbcUrl@" value="${db.url}" />

    <!-- LDAP -->
    <replace file="build/esup-ecm-config-plugin/src/main/resources/config/default-ldap-users-directory-bundle.xml"
	     token="@ldapSearchBaseDn@" value="${ldap.searchBaseDn}" />
    <replace file="build/esup-ecm-config-plugin/src/main/resources/config/default-ldap-users-directory-bundle.xml"
	     token="@ldapUrl@" value="${ldap.url}" />
    
  </target>

  
  <target name="deploy" depends="replace.token.config">
    <copy todir="" overwrite="yes">
      <fileset dir="datasources"/>
      <fileset dir="esup-ecm-config-plugin"/>
    </copy>
    <copy file="build/jboss/jbossctl" tofile="${nuxeo.dir}/bin" overwrite="yes"/>
    <copy file="build/jboss/server.xml" tofile="${nuxeo.dir}/server/default/deploy/jbossweb-tomcat55.sar/server.xml" overwrite="yes"/>
    <subant target="deploy" buildpath="esup-ecm-config-plugin"/>
  </target>


</project>


